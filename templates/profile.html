{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-0">
  <!-- Profile Header -->
  <section class="py-4 bg-gradient-primary text-white">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="d-flex align-items-center mb-3">
            <div class="profile-avatar me-4">
              <img id="profAvatar" class="rounded-circle shadow-lg" 
                   src="https://api.dicebear.com/7.x/avataaars/svg?seed=User&backgroundColor=b6e3f4" 
                   alt="Profile Avatar" width="80" height="80">
              <div class="avatar-overlay">
                <label for="avatarInput" class="btn btn-light btn-sm rounded-pill">
                  <i class="fas fa-camera"></i>
          </label>
                <input id="avatarInput" type="file" accept="image/*" hidden>
              </div>
            </div>
            <div>
              <h2 class="mb-1 fw-bold" id="profName">Your Name</h2>
              <p class="mb-0 text-white-50" id="profEmail">you@example.com</p>
              <div class="mt-2">
                <span class="badge bg-light text-primary me-2" id="userRating">⭐ 5.0</span>
                <span class="badge bg-white bg-opacity-25" id="walletCredits">₹0.00 Credits</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4 text-lg-end">
          <div class="d-flex gap-2 justify-content-lg-end">
            <button class="btn btn-light rounded-pill px-4 py-2" data-bs-toggle="modal" data-bs-target="#editProfileModal">
              <i class="fas fa-edit me-2"></i>Edit Profile
            </button>
            <button class="btn btn-outline-light rounded-pill px-4 py-2" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
              <i class="fas fa-key me-2"></i>Change Password
            </button>
        </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Profile Content -->
  <section class="py-4 bg-white">
    <div class="container">
      <div class="row g-4">
        <!-- Profile Information -->
        <div class="col-lg-4">
          <div class="card shadow-sm rounded-4 border-0 h-100">
            <div class="card-header bg-white border-0 pb-0">
              <h5 class="fw-bold mb-3">Profile Information</h5>
            </div>
            <div class="card-body">
              <div class="info-item d-flex align-items-center mb-3">
                <div class="info-icon me-3">
                  <i class="fas fa-user text-primary"></i>
                </div>
                <div>
                  <div class="fw-semibold">Full Name</div>
                  <div class="text-muted small" id="profNameDisplay">Your Name</div>
                </div>
              </div>
              <div class="info-item d-flex align-items-center mb-3">
                <div class="info-icon me-3">
                  <i class="fas fa-envelope text-primary"></i>
                </div>
                <div>
                  <div class="fw-semibold">Email Address</div>
                  <div class="text-muted small" id="profEmailDisplay">you@example.com</div>
                </div>
              </div>
              <div class="info-item d-flex align-items-center mb-3">
                <div class="info-icon me-3">
                  <i class="fas fa-phone text-primary"></i>
                </div>
                <div>
                  <div class="fw-semibold">Phone Number</div>
                  <div class="text-muted small" id="profPhoneDisplay">Not provided</div>
                </div>
              </div>
              <div class="info-item d-flex align-items-center mb-3">
                <div class="info-icon me-3">
                  <i class="fas fa-map-marker-alt text-primary"></i>
                </div>
                <div>
                  <div class="fw-semibold">Address</div>
                  <div class="text-muted small" id="profAddressDisplay">Not set</div>
                </div>
              </div>
              <div class="info-item d-flex align-items-center">
                <div class="info-icon me-3">
                  <i class="fas fa-calendar text-primary"></i>
                </div>
                <div>
                  <div class="fw-semibold">Member Since</div>
                  <div class="text-muted small" id="memberSince">Recent</div>
                </div>
        </div>
      </div>
    </div>
  </div>

        <!-- Location Management -->
  <div class="col-lg-8">
          <div class="card shadow-sm rounded-4 border-0 h-100">
            <div class="card-header bg-white border-0 pb-0">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="fw-bold mb-0">Location Management</h5>
                <div class="d-flex gap-2">
                  <button id="geoBtn" class="btn btn-outline-primary btn-sm rounded-pill">
                    <i class="fas fa-crosshairs me-1"></i>Use Current Location
                  </button>
                  <button id="saveLoc" class="btn btn-primary btn-sm rounded-pill">
                    <i class="fas fa-save me-1"></i>Save Location
                  </button>
                </div>
              </div>
            </div>
      <div class="card-body">
        <div class="row g-3">
                <div class="col-12">
                  <div id="map" style="height: 300px; border-radius: 0.75rem; overflow: hidden; border: 1px solid rgba(0,0,0,0.1);"></div>
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-semibold">Latitude</label>
                  <input id="lat" class="form-control" placeholder="28.6139" readonly />
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-semibold">Longitude</label>
                  <input id="lon" class="form-control" placeholder="77.2090" readonly />
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-semibold">Status</label>
                  <div id="msg" class="form-control-plaintext text-success small">
                    <i class="fas fa-info-circle me-1"></i>Location not set
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label fw-semibold">Full Address</label>
                  <input id="address" class="form-control" placeholder="Street, City, State, Country" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Statistics and Activity -->
  <section class="py-4 bg-light">
    <div class="container">
      <div class="row g-4">
        <div class="col-lg-3 col-md-6">
          <div class="stat-card p-4 rounded-4 shadow-sm bg-white border-0 text-center hover-lift">
            <div class="stat-icon mx-auto mb-3">
              <i class="fas fa-calendar-check text-primary"></i>
            </div>
            <h3 class="fw-bold mb-1 text-primary" id="totalBookings">0</h3>
            <p class="text-muted mb-0 small">Total Bookings</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card p-4 rounded-4 shadow-sm bg-white border-0 text-center hover-lift">
            <div class="stat-icon mx-auto mb-3">
              <i class="fas fa-star text-warning"></i>
            </div>
            <h3 class="fw-bold mb-1 text-warning" id="averageRating">5.0</h3>
            <p class="text-muted mb-0 small">Average Rating</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card p-4 rounded-4 shadow-sm bg-white border-0 text-center hover-lift">
            <div class="stat-icon mx-auto mb-3">
              <i class="fas fa-rupee-sign text-success"></i>
            </div>
            <h3 class="fw-bold mb-1 text-success" id="totalSpent">₹0</h3>
            <p class="text-muted mb-0 small">Total Spent</p>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="stat-card p-4 rounded-4 shadow-sm bg-white border-0 text-center hover-lift">
            <div class="stat-icon mx-auto mb-3">
              <i class="fas fa-clock text-info"></i>
            </div>
            <h3 class="fw-bold mb-1 text-info" id="activeBookings">0</h3>
            <p class="text-muted mb-0 small">Active Bookings</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Service History -->
  <section class="py-4 bg-white">
    <div class="container">
      <div class="card shadow-sm rounded-4 border-0">
        <div class="card-header bg-white border-0 pb-0">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="fw-bold mb-0">Service History</h5>
            <div class="btn-group btn-group-sm" role="group">
              <input type="radio" class="btn-check" name="serviceFilter" id="allServices" autocomplete="off" checked>
              <label class="btn btn-outline-primary" for="allServices">All</label>
              
              <input type="radio" class="btn-check" name="serviceFilter" id="completedServices" autocomplete="off">
              <label class="btn btn-outline-primary" for="completedServices">Completed</label>
              
              <input type="radio" class="btn-check" name="serviceFilter" id="pendingServices" autocomplete="off">
              <label class="btn btn-outline-primary" for="pendingServices">Pending</label>
      </div>
    </div>
  </div>
      <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Service</th>
                  <th>Provider</th>
              <th>Date</th>
              <th>Status</th>
              <th>Price</th>
              <th>Rating</th>
                  <th>Actions</th>
            </tr>
          </thead>
          <tbody id="pastServices"></tbody>
        </table>
          </div>
          <div id="noServices" class="text-center py-5 d-none">
            <div class="mb-3">
              <i class="fas fa-history text-muted" style="font-size: 3rem;"></i>
            </div>
            <h6 class="text-muted">No service history</h6>
            <p class="text-muted small">Your completed services will appear here</p>
            <a href="/booking-map" class="btn btn-primary rounded-pill">
              <i class="fas fa-plus me-2"></i>Book Your First Service
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="mb-3">
            <label class="form-label fw-semibold">Full Name</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-user"></i></span>
              <input id="editName" class="form-control" placeholder="Enter your full name" required>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Email Address</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-envelope"></i></span>
              <input id="editEmail" type="email" class="form-control" placeholder="Enter your email" required>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Phone Number</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-phone"></i></span>
              <input id="editPhone" class="form-control" placeholder="Enter your phone number">
            </div>
          </div>
          <div id="editMsg" class="alert alert-info d-none">
            <i class="fas fa-info-circle me-2"></i>
            <span></span>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveProfileBtn">
          <i class="fas fa-save me-2"></i>Save Changes
        </button>
      </div>
    </div>
  </div>
  </div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="changePasswordForm">
          <div class="mb-3">
            <label class="form-label fw-semibold">Current Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-lock"></i></span>
              <input id="curPass" type="password" class="form-control" placeholder="Enter current password" required>
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('curPass')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">New Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-key"></i></span>
              <input id="newPass" type="password" class="form-control" placeholder="Enter new password" required>
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('newPass')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <div class="form-text">
              <small>Password must be at least 8 characters long</small>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Confirm New Password</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-key"></i></span>
              <input id="confirmPass" type="password" class="form-control" placeholder="Confirm new password" required>
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPass')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <div id="passMsg" class="alert alert-info d-none">
            <i class="fas fa-info-circle me-2"></i>
            <span></span>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="savePassBtn">
          <i class="fas fa-key me-2"></i>Change Password
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// Enhanced Profile Page JavaScript
(function() {
  'use strict';
  
const token = localStorage.getItem('token') || '';
  let userData = {};
  let map, marker;
  
  // Service icons mapping
  const serviceIcons = {
    'Electrician': 'fas fa-bolt',
    'Plumber': 'fas fa-wrench',
    'Carpenter': 'fas fa-hammer',
    'Cleaner': 'fas fa-broom',
    'Painter': 'fas fa-paint-brush',
    'AC Repair': 'fas fa-snowflake'
  };

  // Initialize profile page
  document.addEventListener('DOMContentLoaded', async function() {
    if (!token) {
      window.location.href = '/login';
      return;
    }
    
    await loadUserData();
    await loadServiceHistory();
    setupEventListeners();
  });

  // Load user data and populate UI
  async function loadUserData() {
    try {
      const response = await fetch('/me', { 
        headers: { 'Authorization': `Bearer ${token}` } 
      });
      
      if (!response.ok) return;
      
      const me = await response.json();
      userData = me;
      
      // Update profile header
      document.getElementById('profName').textContent = me.name || 'Your Name';
      document.getElementById('profEmail').textContent = me.email || 'you@example.com';
      document.getElementById('userRating').textContent = `⭐ ${Number(me.rating || 0).toFixed(1)}`;
      document.getElementById('walletCredits').textContent = `₹${Number(me.credits || 0).toFixed(2)} Credits`;
      
      // Update profile information section
      document.getElementById('profNameDisplay').textContent = me.name || 'Your Name';
      document.getElementById('profEmailDisplay').textContent = me.email || 'you@example.com';
      document.getElementById('profPhoneDisplay').textContent = me.phone || 'Not provided';
      document.getElementById('profAddressDisplay').textContent = me.address || 'Not set';
      
      // Set avatar
      if (me.avatar_url) {
        document.getElementById('profAvatar').src = me.avatar_url;
      } else {
        // Generate avatar based on name
        const name = me.name || 'User';
        const initials = encodeURIComponent(name.split(' ').map(p => p[0]).join('').slice(0, 2));
        document.getElementById('profAvatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${initials}&backgroundColor=b6e3f4`;
      }
      
      // Prefill edit modal
  document.getElementById('editName').value = me.name || '';
  document.getElementById('editEmail').value = me.email || '';
  document.getElementById('editPhone').value = me.phone || '';
      
      // Set location
      if (me.latitude) {
        document.getElementById('lat').value = me.latitude;
        document.getElementById('msg').innerHTML = '<i class="fas fa-check-circle me-1"></i>Location set';
        document.getElementById('msg').className = 'form-control-plaintext text-success small';
      }
      if (me.longitude) {
        document.getElementById('lon').value = me.longitude;
      }
      if (me.address) {
        document.getElementById('address').value = me.address;
      }
      
      // Update map with user location if available
      if (me.latitude && me.longitude) {
        initMap(me.latitude, me.longitude);
      } else {
        initMap(28.6139, 77.2090); // Default to Delhi
      }
      
      // Update statistics
      await updateStatistics();
      
    } catch (error) {
      console.error('Error loading user data:', error);
    }
  }

  // Update user statistics
  async function updateStatistics() {
    try {
      const response = await fetch('/bookings/user', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const bookings = await response.json();
        const totalBookings = bookings.length;
        const activeBookings = bookings.filter(b => ['Pending', 'Accepted', 'In Progress'].includes(b.status)).length;
        const completedBookings = bookings.filter(b => b.status === 'Completed');
        const averageRating = completedBookings.length > 0 
          ? (completedBookings.reduce((sum, b) => sum + (b.rating || 0), 0) / completedBookings.length).toFixed(1)
          : '5.0';
        const totalSpent = bookings
          .filter(b => b.status === 'Completed')
          .reduce((sum, b) => sum + (b.price || 0), 0);

        document.getElementById('totalBookings').textContent = totalBookings;
        document.getElementById('activeBookings').textContent = activeBookings;
        document.getElementById('averageRating').textContent = averageRating;
        document.getElementById('totalSpent').textContent = `₹${totalSpent}`;
      }
    } catch (error) {
      console.error('Error loading statistics:', error);
    }
  }

  // Load service history
  async function loadServiceHistory() {
    try {
      const response = await fetch('/bookings/user', { 
        headers: { 'Authorization': `Bearer ${token}` } 
      });
      
      if (!response.ok) return;
      
      const bookings = await response.json();
      renderServiceHistory(bookings);
      
    } catch (error) {
      console.error('Error loading service history:', error);
    }
  }

  // Render service history table
  function renderServiceHistory(bookings) {
    const tbody = document.getElementById('pastServices');
    tbody.innerHTML = '';
    
    if (bookings.length === 0) {
      document.getElementById('noServices').classList.remove('d-none');
      return;
    }
    
    document.getElementById('noServices').classList.add('d-none');
    
    bookings.slice(0, 10).forEach(booking => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <div class="d-flex align-items-center">
            <div class="service-icon-small me-2">
              <i class="${serviceIcons[booking.service_name] || 'fas fa-tools'} text-primary"></i>
            </div>
            <div>
              <div class="fw-semibold">${booking.service_name || 'Service'}</div>
              <small class="text-muted">${booking.service_id || ''}</small>
            </div>
          </div>
        </td>
        <td>
          <div class="d-flex align-items-center">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Provider&backgroundColor=ffd93d" 
                 class="rounded-circle me-2" width="24" alt="Provider">
            <span>Provider</span>
          </div>
        </td>
        <td>
          <div class="small">${formatDate(booking.created_at)}</div>
        </td>
        <td>
          <span class="badge bg-${getStatusColor(booking.status)}">${booking.status}</span>
        </td>
        <td class="fw-semibold">₹${booking.price || 0}</td>
        <td>
          ${booking.status === 'Completed' ? `
            <div class="rating-controls">
              ${booking.rating ? `
                <div class="rating-display">
                  ${'⭐'.repeat(booking.rating)}
                  <span class="ms-1 small text-muted">(${booking.rating}/5)</span>
                </div>
              ` : `
                <div class="btn-group btn-group-sm" role="group">
                  ${[1,2,3,4,5].map(n => `
                    <button class="btn btn-outline-warning rateBtn" data-id="${booking.id}" data-val="${n}">
                      ${'⭐'.repeat(n)}
                    </button>
                  `).join('')}
                </div>
              `}
            </div>
          ` : '<span class="text-muted small">Not completed</span>'}
        </td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary btn-sm" onclick="viewBooking('${booking.id}')">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    // Add rating event listeners
    tbody.addEventListener('click', async (e) => {
      const btn = e.target.closest('.rateBtn');
      if (!btn) return;
      
      const bookingId = btn.getAttribute('data-id');
      const rating = Number(btn.getAttribute('data-val'));
      
      try {
        const response = await fetch('/bookings/rate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ booking_id: bookingId, rating })
        });
        
        if (response.ok) {
          btn.closest('.rating-controls').innerHTML = `
            <div class="rating-display">
              ${'⭐'.repeat(rating)}
              <span class="ms-1 small text-muted">(${rating}/5)</span>
            </div>
          `;
          showNotification('Rating submitted successfully!', 'success');
        }
      } catch (error) {
        console.error('Error submitting rating:', error);
        showNotification('Failed to submit rating', 'error');
      }
    });
  }

  // Setup event listeners
  function setupEventListeners() {
// Avatar upload
    document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
    
    // Edit profile save
    document.getElementById('saveProfileBtn').addEventListener('click', handleProfileSave);
    
    // Change password
    document.getElementById('savePassBtn').addEventListener('click', handlePasswordChange);
    
    // Location buttons
    document.getElementById('geoBtn').addEventListener('click', handleLocationDetect);
    document.getElementById('saveLoc').addEventListener('click', handleLocationSave);
    
    // Service filter buttons
    document.querySelectorAll('input[name="serviceFilter"]').forEach(radio => {
      radio.addEventListener('change', function() {
        filterServices(this.id);
      });
    });
  }

  // Handle avatar upload
  async function handleAvatarUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
    
    try {
      const formData = new FormData();
      formData.append('avatar', file);
      
      const response = await fetch('/profile/avatar', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      
      const result = await response.json();
      if (response.ok && result.avatar_url) {
        document.getElementById('profAvatar').src = result.avatar_url;
        showNotification('Avatar updated successfully!', 'success');
      } else {
        showNotification(result.message || 'Failed to update avatar', 'error');
      }
    } catch (error) {
      console.error('Error uploading avatar:', error);
      showNotification('Failed to update avatar', 'error');
    }
  }

  // Handle profile save
  async function handleProfileSave() {
  const payload = {
    name: document.getElementById('editName').value,
    email: document.getElementById('editEmail').value,
    phone: document.getElementById('editPhone').value,
  };
    
    try {
      const response = await fetch('/profile/update', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      
      const result = await response.json();
      const msg = document.getElementById('editMsg');
      
      if (response.ok) {
        msg.className = 'alert alert-success';
        msg.querySelector('span').textContent = 'Profile updated successfully!';
        msg.classList.remove('d-none');
        
        // Update UI
        document.getElementById('profName').textContent = payload.name;
        document.getElementById('profEmail').textContent = payload.email;
        document.getElementById('profNameDisplay').textContent = payload.name;
        document.getElementById('profEmailDisplay').textContent = payload.email;
        document.getElementById('profPhoneDisplay').textContent = payload.phone || 'Not provided';
        
        setTimeout(() => {
          bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
        }, 1500);
      } else {
        msg.className = 'alert alert-danger';
        msg.querySelector('span').textContent = result.message || 'Failed to update profile';
        msg.classList.remove('d-none');
      }
    } catch (error) {
      console.error('Error updating profile:', error);
  const msg = document.getElementById('editMsg');
      msg.className = 'alert alert-danger';
      msg.querySelector('span').textContent = 'Failed to update profile';
      msg.classList.remove('d-none');
    }
  }

  // Handle password change
  async function handlePasswordChange() {
    const currentPassword = document.getElementById('curPass').value;
    const newPassword = document.getElementById('newPass').value;
    const confirmPassword = document.getElementById('confirmPass').value;
    
    if (newPassword !== confirmPassword) {
      const msg = document.getElementById('passMsg');
      msg.className = 'alert alert-danger';
      msg.querySelector('span').textContent = 'New passwords do not match';
      msg.classList.remove('d-none');
      return;
    }
    
    if (newPassword.length < 8) {
      const msg = document.getElementById('passMsg');
      msg.className = 'alert alert-danger';
      msg.querySelector('span').textContent = 'Password must be at least 8 characters long';
      msg.classList.remove('d-none');
      return;
    }
    
    try {
      const response = await fetch('/profile/password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          current_password: currentPassword,
          new_password: newPassword
        })
      });
      
      const result = await response.json();
      const msg = document.getElementById('passMsg');
      
      if (response.ok) {
        msg.className = 'alert alert-success';
        msg.querySelector('span').textContent = 'Password changed successfully!';
        msg.classList.remove('d-none');
        
        // Clear form
        document.getElementById('curPass').value = '';
        document.getElementById('newPass').value = '';
        document.getElementById('confirmPass').value = '';
        
        setTimeout(() => {
          bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
        }, 1500);
      } else {
        msg.className = 'alert alert-danger';
        msg.querySelector('span').textContent = result.message || 'Failed to change password';
        msg.classList.remove('d-none');
      }
    } catch (error) {
      console.error('Error changing password:', error);
      const msg = document.getElementById('passMsg');
      msg.className = 'alert alert-danger';
      msg.querySelector('span').textContent = 'Failed to change password';
      msg.classList.remove('d-none');
    }
  }

  // Handle location detection
  function handleLocationDetect() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        
        document.getElementById('lat').value = lat;
        document.getElementById('lon').value = lon;
        
        const addr = await reverseGeocode(lat, lon);
        document.getElementById('address').value = addr;
        document.getElementById('profAddressDisplay').textContent = addr;
        
        if (!map) {
          initMap(lat, lon);
        } else {
          marker.setLatLng([lat, lon]);
          map.setView([lat, lon], 15);
        }
        
        document.getElementById('msg').innerHTML = '<i class="fas fa-check-circle me-1"></i>Location detected';
        document.getElementById('msg').className = 'form-control-plaintext text-success small';
      }, () => {
        document.getElementById('msg').innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Location access denied';
        document.getElementById('msg').className = 'form-control-plaintext text-danger small';
      });
    }
  }

  // Handle location save
  async function handleLocationSave() {
    const lat = Number(document.getElementById('lat').value);
    const lon = Number(document.getElementById('lon').value);
    const address = document.getElementById('address').value;
    
    if (!lat || !lon) {
      document.getElementById('msg').innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Please set a location first';
      document.getElementById('msg').className = 'form-control-plaintext text-warning small';
      return;
    }
    
    try {
      const response = await fetch('/profile/location', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ lat, lon, address })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        document.getElementById('msg').innerHTML = '<i class="fas fa-check-circle me-1"></i>Location saved successfully';
        document.getElementById('msg').className = 'form-control-plaintext text-success small';
        
        if (result.address) {
          document.getElementById('profAddressDisplay').textContent = result.address;
        }
        
        showNotification('Location saved successfully!', 'success');
      } else {
        document.getElementById('msg').innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Failed to save location';
        document.getElementById('msg').className = 'form-control-plaintext text-danger small';
      }
    } catch (error) {
      console.error('Error saving location:', error);
      document.getElementById('msg').innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Failed to save location';
      document.getElementById('msg').className = 'form-control-plaintext text-danger small';
    }
  }

  // Initialize map
  function initMap(lat = 28.6139, lon = 77.2090) {
  map = L.map('map').setView([lat, lon], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
  marker = L.marker([lat, lon], { draggable: true }).addTo(map);
    
  marker.on('dragend', async () => {
    const { lat, lng } = marker.getLatLng();
      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lon').value = lng.toFixed(6);
      
    const addr = await reverseGeocode(lat, lng);
    document.getElementById('address').value = addr;
      document.getElementById('profAddressDisplay').textContent = addr;
    });
  }

  // Reverse geocoding
  async function reverseGeocode(lat, lon) {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`);
      const data = await response.json();
      return data.display_name || '';
    } catch (error) {
      console.error('Error reverse geocoding:', error);
      return '';
    }
  }

  // Filter services
  function filterServices(filterId) {
    // This would filter the service history table
    console.log('Filter services:', filterId);
  }

  // Utility functions
  function getStatusColor(status) {
    switch(status) {
      case 'Pending': return 'warning';
      case 'Accepted': return 'primary';
      case 'In Progress': return 'info';
      case 'Completed': return 'success';
      case 'Cancelled': return 'secondary';
      case 'Rejected': return 'danger';
      default: return 'light';
    }
  }

  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  }

  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        <span>${message}</span>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
      </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }

  // Global functions
  window.togglePassword = function(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
      input.type = 'text';
      icon.className = 'fas fa-eye-slash';
    } else {
      input.type = 'password';
      icon.className = 'fas fa-eye';
    }
  };

  window.viewBooking = function(bookingId) {
    console.log('View booking:', bookingId);
    // Implement booking view modal
  };


})();
</script>
{% endblock %}

