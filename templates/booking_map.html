{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-0">
  <!-- Header Section -->
  <section class="py-4 bg-white border-bottom">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="d-flex align-items-center mb-2">
            <a href="/" class="btn btn-outline-secondary btn-sm me-3">
              <i class="fas fa-arrow-left me-2"></i>Back to Home
            </a>
            <h2 class="mb-0 fw-bold text-primary">Choose Your Service Provider</h2>
          </div>
          <p class="text-muted mb-0">Select from verified professionals in your area</p>
        </div>
        <div class="col-lg-4 text-lg-end">
          <div class="booking-summary-card p-3 rounded-4 bg-light border">
            <div class="d-flex align-items-center mb-2">
              <div class="service-icon-small me-3">
                <i id="serviceIcon" class="fas fa-tools text-primary"></i>
              </div>
              <div>
                <h6 class="mb-0 fw-bold" id="serviceName">Service</h6>
                <small class="text-muted" id="serviceCategory">Category</small>
              </div>
            </div>
            <div class="d-flex justify-content-between">
              <span class="text-muted small">Starting from:</span>
              <span class="fw-bold text-primary" id="servicePrice">â‚¹0</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Map and Provider Selection -->
  <section class="py-4">
    <div class="container-fluid">
      <div class="row g-0">
        <!-- Map Section -->
        <div class="col-lg-8">
          <div class="map-container position-relative">
            <div id="map" style="height: 70vh; border-radius: 0.75rem; overflow: hidden;"></div>
            <div class="map-controls position-absolute top-0 end-0 m-3">
              <button id="locateBtn" class="btn btn-light shadow-sm rounded-pill" title="Use my location">
                <i class="fas fa-crosshairs"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Provider List Section -->
        <div class="col-lg-4">
          <div class="provider-panel h-100 bg-white border-start">
            <div class="p-4 border-bottom">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0 fw-bold">Available Providers</h5>
                <span class="badge bg-primary" id="providerCount">0</span>
              </div>
              <div class="search-box mb-3">
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="fas fa-search text-muted"></i>
                  </span>
                  <input type="text" class="form-control border-start-0" id="providerSearch" placeholder="Search providers...">
                </div>
              </div>
              <div class="service-filter">
                <select class="form-select form-select-sm" id="serviceFilter">
                  <option value="">All Services</option>
                </select>
              </div>
            </div>
            
            <div class="provider-list p-4" style="max-height: calc(70vh - 140px); overflow-y: auto;">
              <div id="providerList" class="vstack gap-3">
                <!-- Providers will be loaded here -->
              </div>
              
              <div id="noProviders" class="text-center py-5 d-none">
                <div class="mb-3">
                  <i class="fas fa-map-marker-alt text-muted" style="font-size: 3rem;"></i>
                </div>
                <h6 class="text-muted">No providers found</h6>
                <p class="text-muted small">Try adjusting your location or check back later</p>
              </div>
              
              <div id="loadingProviders" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted small mt-2">Finding providers...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quick Booking Form Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content rounded-4">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Confirm Booking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="provider-info-card p-3 rounded-3 bg-light">
                <div class="d-flex align-items-center mb-3">
                  <div class="provider-avatar me-3">
                    <img id="modalProviderAvatar" src="" alt="Provider" class="rounded-circle" width="50">
                  </div>
                  <div>
                    <h6 class="mb-0 fw-bold" id="modalProviderName">Provider Name</h6>
                    <div class="rating mb-1">
                      <i class="fas fa-star text-warning"></i>
                      <span id="modalProviderRating" class="ms-1">4.9</span>
                      <span class="text-muted ms-2" id="modalProviderJobs">(50 jobs)</span>
                    </div>
                  </div>
                </div>
                <div class="skills">
                  <small class="text-muted">Skills:</small>
                  <div id="modalProviderSkills" class="mt-1"></div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <form id="bookingForm">
                <div class="mb-3">
                  <label class="form-label fw-semibold">When do you need this service?</label>
                  <select class="form-select" id="urgencySelect" required>
                    <option value="">Select urgency</option>
                    <option value="emergency">ðŸš¨ Emergency (ASAP)</option>
                    <option value="today">ðŸ“… Today</option>
                    <option value="tomorrow">ðŸ“… Tomorrow</option>
                    <option value="this-week">ðŸ“… This Week</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-semibold">Estimated Duration</label>
                  <select class="form-select" id="durationSelect">
                    <option value="1">1 hour</option>
                    <option value="2">2 hours</option>
                    <option value="4" selected>4 hours</option>
                    <option value="8">Full day</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-semibold">Special Instructions</label>
                  <textarea class="form-control" id="bookingNotes" rows="3" placeholder="Any specific requirements or notes..."></textarea>
                </div>
                <div class="price-summary p-3 rounded-3 bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-semibold">Estimated Total:</span>
                    <span class="h5 mb-0 text-primary fw-bold" id="estimatedTotal">â‚¹0</span>
                  </div>
                  <small class="text-muted">Final price may vary based on job complexity</small>
                </div>
              </form>
            </div>
          </div>
        </div>
                <div class="modal-footer border-0 pt-0">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-outline-success" id="trackProviderBtn" style="display: none;">
                    <i class="fas fa-map-marker-alt me-2"></i>Track Provider
                  </button>
                  <button type="button" class="btn btn-primary btn-lg px-4" id="confirmBookingBtn">
                    <i class="fas fa-calendar-check me-2"></i>Confirm Booking
                  </button>
                </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Service icons mapping
const serviceIcons = {
  'Electrician': 'fas fa-bolt',
  'Plumber': 'fas fa-wrench',
  'Carpenter': 'fas fa-hammer',
  'Cleaner': 'fas fa-broom',
  'Painter': 'fas fa-paint-brush',
  'AC Repair': 'fas fa-snowflake'
};

// Global variables
let map;
let userLocation = null;
let providers = [];
let selectedProvider = null;
let serviceData = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', async function() {
  // Get service data from URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const serviceId = urlParams.get('service_id');
  const serviceType = urlParams.get('service_type');
  
  if (serviceId) {
    await loadServiceData(serviceId);
  } else if (serviceType) {
    // Create mock service data for direct booking from home
    serviceData = {
      id: serviceType,
      name: serviceType.charAt(0).toUpperCase() + serviceType.slice(1),
      category: getServiceCategory(serviceType),
      base_price: getServicePrice(serviceType)
    };
  }
  
  updateServiceSummary();
  initializeMap();
  await loadAvailableServices();
  await loadProviders();
});

// Load service data
async function loadServiceData(serviceId) {
  try {
    console.log('Loading service data for ID:', serviceId);
    const response = await fetch('/services');
    const services = await response.json();
    console.log('Available services:', services);
    serviceData = services.find(s => s.id === serviceId);
    console.log('Found service data:', serviceData);
    
    if (!serviceData) {
      console.error('Service not found for ID:', serviceId);
      alert('Service not found. Please try again.');
      return;
    }
  } catch (error) {
    console.error('Error loading service data:', error);
    alert('Error loading service information. Please try again.');
  }
}

// Get service category and price
function getServiceCategory(serviceType) {
  const categories = {
    'electrician': 'Electrical',
    'plumber': 'Plumbing',
    'carpenter': 'Woodwork',
    'cleaner': 'Cleaning',
    'painter': 'Painting',
    'ac': 'AC Repair'
  };
  return categories[serviceType] || 'Professional Service';
}

function getServicePrice(serviceType) {
  const prices = {
    'electrician': 500,
    'plumber': 450,
    'carpenter': 600,
    'cleaner': 300,
    'painter': 400,
    'ac': 800
  };
  return prices[serviceType] || 500;
}

// Update service summary
function updateServiceSummary() {
  if (!serviceData) return;
  
  const icon = serviceIcons[serviceData.name] || 'fas fa-tools';
  document.getElementById('serviceIcon').className = icon;
  document.getElementById('serviceName').textContent = serviceData.name;
  document.getElementById('serviceCategory').textContent = serviceData.category || '';
  document.getElementById('servicePrice').textContent = `â‚¹${serviceData.base_price}`;
}

// Initialize map
function initializeMap() {
  map = L.map('map').setView([28.6139, 77.2090], 12);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);
  
  // Add user location button
  document.getElementById('locateBtn').addEventListener('click', () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        userLocation = { lat, lon };
        
        map.setView([lat, lon], 15);
        L.circleMarker([lat, lon], {
          radius: 8,
          color: '#0d6efd',
          fillColor: '#0d6efd',
          fillOpacity: 0.8
        }).addTo(map).bindPopup('Your location');
        
        loadProviders(lat, lon);
      });
    }
  });
}

// Load available services for filter
async function loadAvailableServices() {
  try {
    const response = await fetch('/services');
    const services = await response.json();
    
    const select = document.getElementById('serviceFilter');
    select.innerHTML = '<option value="">All Services</option>';
    
    services.forEach(service => {
      const option = document.createElement('option');
      option.value = service.name.toLowerCase();
      option.textContent = service.name;
      select.appendChild(option);
    });
    
    // Set default service if coming from home page
    if (serviceData) {
      select.value = serviceData.name.toLowerCase();
      select.dispatchEvent(new Event('change'));
    }
  } catch (error) {
    console.error('Error loading available services:', error);
  }
}

// Load providers
async function loadProviders(lat = null, lon = null, serviceType = null) {
  try {
    document.getElementById('loadingProviders').classList.remove('d-none');
    document.getElementById('noProviders').classList.add('d-none');
    
    const params = new URLSearchParams();
    if (lat && lon) {
      params.append('lat', lat);
      params.append('lon', lon);
    }
    if (serviceType) {
      params.append('service_type', serviceType);
    }
    
    console.log(`Loading providers with params: ${params.toString()}`);
    const response = await fetch(`/providers/nearby?${params.toString()}`);
    providers = await response.json();
    
    console.log(`Loaded ${providers.length} providers:`, providers);
    
    renderProviders();
    updateProviderCount();
    
    document.getElementById('loadingProviders').classList.add('d-none');
    if (providers.length === 0) {
      document.getElementById('noProviders').classList.remove('d-none');
      console.log('No providers found - showing empty state');
    }
  } catch (error) {
    console.error('Error loading providers:', error);
    document.getElementById('loadingProviders').classList.add('d-none');
    document.getElementById('noProviders').classList.remove('d-none');
  }
}

// Render providers on map and list
function renderProviders() {
  // Clear existing markers
  map.eachLayer(layer => {
    if (layer instanceof L.Marker) {
      map.removeLayer(layer);
    }
  });
  
  const providerList = document.getElementById('providerList');
  providerList.innerHTML = '';
  
  providers.forEach((provider, index) => {
    // Add marker to map
    const marker = L.marker([provider.lat, provider.lon]).addTo(map);
    
    const popupContent = `
      <div class="provider-popup">
        <div class="d-flex align-items-center mb-2">
          <img src="${provider.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + provider.name}" 
               class="rounded-circle me-2" width="40" alt="${provider.name}">
          <div>
            <h6 class="mb-0 fw-bold">${provider.name}</h6>
            <div class="rating">
              <i class="fas fa-star text-warning"></i>
              <span class="ms-1">${provider.rating}</span>
              <span class="text-muted ms-2">(${provider.jobs_count} jobs)</span>
            </div>
          </div>
        </div>
        <div class="mb-2">
          <small class="text-muted">Skills:</small>
          <div class="skills mt-1">
            ${provider.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-bold text-primary">â‚¹${provider.hourly_rate || serviceData.base_price}/hr</span>
          <button class="btn btn-primary btn-sm" onclick="selectProvider('${provider.id}')">
            Select
          </button>
        </div>
      </div>
    `;
    
    marker.bindPopup(popupContent);
    
    // Add to provider list
    const providerCard = document.createElement('div');
    providerCard.className = 'provider-card p-3 rounded-3 border hover-lift';
    providerCard.innerHTML = `
      <div class="d-flex align-items-center mb-3">
        <img src="${provider.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + provider.name}" 
             class="rounded-circle me-3" width="50" alt="${provider.name}">
        <div class="flex-grow-1">
          <h6 class="mb-0 fw-bold">${provider.name}</h6>
          <div class="rating mb-1">
            <i class="fas fa-star text-warning"></i>
            <span class="ms-1">${provider.rating}</span>
            <span class="text-muted ms-2">(${provider.jobs_count} jobs)</span>
          </div>
          <div class="text-muted small">
            <i class="fas fa-map-marker-alt me-1"></i>
            ${provider.distance_km ? provider.distance_km.toFixed(1) + ' km away' : 'Distance unknown'}
          </div>
        </div>
        <div class="text-end">
          <div class="fw-bold text-primary mb-1">â‚¹${provider.hourly_rate || serviceData.base_price}/hr</div>
          <button class="btn btn-outline-primary btn-sm" onclick="selectProvider('${provider.id}')">
            Select
          </button>
        </div>
      </div>
      <div class="skills">
        <small class="text-muted">Skills:</small>
        <div class="mt-1">
          ${provider.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
        </div>
      </div>
    `;
    
    providerList.appendChild(providerCard);
    
    // Add click handler to center map on provider
    providerCard.addEventListener('click', () => {
      map.setView([provider.lat, provider.lon], 15);
      marker.openPopup();
    });
  });
}

// Update provider count
function updateProviderCount() {
  document.getElementById('providerCount').textContent = providers.length;
}

// Select provider
function selectProvider(providerId) {
  console.log('Selecting provider:', providerId);
  console.log('Available providers:', providers);
  selectedProvider = providers.find(p => p.id === providerId);
  console.log('Selected provider:', selectedProvider);
  
  if (!selectedProvider) {
    console.error('Provider not found:', providerId);
    alert('Provider not found. Please try again.');
    return;
  }
  
  // Update modal with provider info
  document.getElementById('modalProviderAvatar').src = selectedProvider.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + selectedProvider.name;
  document.getElementById('modalProviderName').textContent = selectedProvider.name;
  document.getElementById('modalProviderRating').textContent = selectedProvider.rating;
  document.getElementById('modalProviderJobs').textContent = `(${selectedProvider.jobs_count} jobs)`;
  
  const skillsContainer = document.getElementById('modalProviderSkills');
  skillsContainer.innerHTML = selectedProvider.skills.map(skill => 
    `<span class="badge bg-light text-dark me-1">${skill}</span>`
  ).join('');
  
          updateEstimatedPrice();
          
          // Show track provider button if provider is selected
          const trackBtn = document.getElementById('trackProviderBtn');
          trackBtn.style.display = 'inline-block';
          
          // Show modal
          const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
          modal.show();
}

// Update estimated price
function updateEstimatedPrice() {
  const duration = parseInt(document.getElementById('durationSelect').value);
  const hourlyRate = selectedProvider.hourly_rate || serviceData.base_price;
  const estimatedTotal = hourlyRate * duration;
  
  document.getElementById('estimatedTotal').textContent = `â‚¹${estimatedTotal}`;
}

// Track provider button
document.getElementById('trackProviderBtn').addEventListener('click', function() {
  if (selectedProvider) {
    window.location.href = `/track-provider?provider_id=${selectedProvider.id}`;
  }
});

// Confirm booking
document.getElementById('confirmBookingBtn').addEventListener('click', async function() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';
    return;
  }
  
  if (!selectedProvider) {
    alert('Please select a provider');
    return;
  }
  
  const bookingData = {
    service_id: serviceData?.id,
    provider_id: selectedProvider?.id,
    urgency: document.getElementById('urgencySelect').value,
    duration: parseInt(document.getElementById('durationSelect').value),
    notes: document.getElementById('bookingNotes').value,
    location_lat: userLocation?.lat || 28.6139,
    location_lon: userLocation?.lon || 77.2090,
    price: (selectedProvider?.hourly_rate || serviceData?.base_price || 0) * parseInt(document.getElementById('durationSelect').value)
  };
  
  console.log('Sending booking data:', bookingData);
  console.log('Selected provider:', selectedProvider);
  console.log('Service data:', serviceData);
  
  // Validate required data
  if (!bookingData.service_id) {
    console.error('Missing service_id');
    alert('Service information is missing. Please try again.');
    return;
  }
  
  if (!bookingData.provider_id) {
    console.error('Missing provider_id');
    alert('Provider information is missing. Please select a provider.');
    return;
  }
  
  try {
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Booking...';
    
    const response = await fetch('/bookings/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(bookingData)
    });
    
    const result = await response.json();
    console.log('Booking response:', result);
    console.log('Response status:', response.status);
    
    if (response.ok) {
      // Show success message
      alert('Booking confirmed! Your provider will be notified.');
      console.log('Booking created successfully, redirecting to dashboard');
      window.location.href = '/dashboard/user';
    } else {
      console.error('Booking failed:', result);
      console.error('Response status:', response.status);
      console.error('Response headers:', response.headers);
      
      let errorMessage = 'Booking failed. Please try again.';
      if (result.message) {
        errorMessage = result.message;
      } else if (response.status === 401) {
        errorMessage = 'Please login to continue';
        window.location.href = '/login';
        return;
      } else if (response.status === 400) {
        errorMessage = 'Invalid booking data. Please check your information.';
      }
      
      alert(errorMessage);
    }
  } catch (error) {
    console.error('Error creating booking:', error);
    alert('An error occurred. Please try again.');
  } finally {
    this.disabled = false;
    this.innerHTML = '<i class="fas fa-calendar-check me-2"></i>Confirm Booking';
  }
});

// Update price when duration changes
document.getElementById('durationSelect').addEventListener('change', updateEstimatedPrice);

// Search providers
document.getElementById('providerSearch').addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const providerCards = document.querySelectorAll('.provider-card');
  
  providerCards.forEach(card => {
    const name = card.querySelector('h6').textContent.toLowerCase();
    const skills = card.textContent.toLowerCase();
    
    if (name.includes(searchTerm) || skills.includes(searchTerm)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
});

// Service filter change
document.getElementById('serviceFilter').addEventListener('change', function() {
  const selectedService = this.value;
  const currentLocation = userLocation;
  
  if (currentLocation) {
    loadProviders(currentLocation.lat, currentLocation.lon, selectedService);
  } else {
    loadProviders(null, null, selectedService);
  }
});
</script>

<style>
.provider-card {
  transition: all 0.3s ease;
  cursor: pointer;
}

.provider-card:hover {
  border-color: #0d6efd !important;
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
}

.service-icon-small {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.provider-avatar img {
  width: 50px;
  height: 50px;
  object-fit: cover;
}

.booking-summary-card {
  border: 1px solid rgba(0, 0, 0, 0.1);
}

.map-controls .btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.provider-panel {
  border-left: 1px solid rgba(0, 0, 0, 0.1);
}

.search-box .input-group-text {
  border-color: #dee2e6;
}

.price-summary {
  border: 1px solid rgba(0, 0, 0, 0.1);
}

@media (max-width: 992px) {
  .provider-panel {
    border-left: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  #map {
    height: 50vh !important;
  }
  
  .provider-list {
    max-height: 40vh !important;
  }
}
</style>
{% endblock %}
