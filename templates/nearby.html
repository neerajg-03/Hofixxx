{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-0">
  <!-- Header Section -->
  <section class="py-4 bg-white border-bottom">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="d-flex align-items-center mb-2">
            <a href="/dashboard/user" class="btn btn-outline-secondary btn-sm me-3">
              <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
            <h2 class="mb-0 fw-bold text-primary">Providers Near You</h2>
          </div>
          <p class="text-muted mb-0">Find and connect with local service providers</p>
        </div>
        <div class="col-lg-4 text-lg-end">
          <div class="d-flex gap-2">
            <button id="refreshProviders" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <button id="locateBtn" class="btn btn-primary btn-sm">
              <i class="fas fa-crosshairs me-2"></i>My Location
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Map and Providers -->
  <section class="py-4">
    <div class="container-fluid">
      <div class="row g-0">
        <div class="col-lg-8">
          <div class="map-container position-relative">
            <div id="map" style="height: 70vh; border-radius: 0.75rem; overflow: hidden;"></div>
            <div class="map-controls position-absolute top-0 end-0 m-3">
              <div class="btn-group-vertical">
                <button id="zoomIn" class="btn btn-light shadow-sm" title="Zoom In">
                  <i class="fas fa-plus"></i>
                </button>
                <button id="zoomOut" class="btn btn-light shadow-sm" title="Zoom Out">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="provider-panel h-100 bg-white border-start">
            <div class="p-4 border-bottom">
              <div class="d-flex align-items-center justify-content-between mb-3">
                <h5 class="mb-0 fw-bold">Available Providers</h5>
                <span class="badge bg-primary" id="providerCount">0</span>
              </div>
              <div class="search-box">
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="fas fa-search text-muted"></i>
                  </span>
                  <input type="text" class="form-control border-start-0" id="providerSearch" placeholder="Search providers...">
                </div>
              </div>
            </div>
            
            <div class="provider-list p-4" style="max-height: calc(70vh - 140px); overflow-y: auto;">
              <div id="list" class="vstack gap-3">
                <!-- Providers will be loaded here -->
              </div>
              
              <div id="noProviders" class="text-center py-5 d-none">
                <div class="mb-3">
                  <i class="fas fa-map-marker-alt text-muted" style="font-size: 3rem;"></i>
                </div>
                <h6 class="text-muted">No providers found</h6>
                <p class="text-muted small">Try adjusting your location or check back later</p>
              </div>
              
              <div id="loadingProviders" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted small mt-2">Finding providers...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}
{% block scripts %}
<script>
const initLat = Number('{{ lat or "" }}') || null;
const initLon = Number('{{ lon or "" }}') || null;
let map;
let userLocation = null;
let providers = [];

// Initialize map
function initializeMap() {
  map = L.map('map').setView([28.6139, 77.2090], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
    attribution: '© OpenStreetMap contributors' 
  }).addTo(map);
  
  // Add zoom controls
  document.getElementById('zoomIn').addEventListener('click', () => {
    map.zoomIn();
  });
  
  document.getElementById('zoomOut').addEventListener('click', () => {
    map.zoomOut();
  });
}

function renderProviders(providers, userLat, userLon) {
  // Clear existing markers
  map.eachLayer(layer => {
    if (layer instanceof L.Marker) {
      map.removeLayer(layer);
    }
  });
  
  const providerList = document.getElementById('list');
  providerList.innerHTML = '';
  
  let nearest = null;
  let nearestDist = Infinity;
  
  providers.forEach(p => {
    const marker = L.marker([p.lat, p.lon]).addTo(map);
    const html = `
      <div class="provider-popup">
        <div class="d-flex align-items-center mb-2">
          <img src="${p.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + p.name}" 
               class="rounded-circle me-2" width="40" alt="${p.name}">
          <div>
            <h6 class="mb-0 fw-bold">${p.name}</h6>
            <div class="rating">
              <i class="fas fa-star text-warning"></i>
              <span class="ms-1">${p.rating}</span>
              <span class="text-muted ms-2">(${p.jobs_count} jobs)</span>
            </div>
          </div>
        </div>
        <div class="mb-2">
          <small class="text-muted">Skills:</small>
          <div class="skills mt-1">
            ${p.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
          </div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-bold text-primary">₹${p.hourly_rate || 500}/hr</span>
          <button class="btn btn-primary btn-sm bookBtn" data-id='${p.id || ''}'>Book Now</button>
        </div>
      </div>
    `;
    marker.bindPopup(html);
    
    if (typeof p.distance_km === 'number' && p.distance_km < nearestDist) {
      nearestDist = p.distance_km;
      nearest = marker;
    }

    const card = document.createElement('div');
    card.className = 'provider-card p-3 rounded-3 border hover-lift';
    card.innerHTML = `
      <div class="d-flex align-items-center mb-3">
        <img src="${p.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + p.name}" 
             class="rounded-circle me-3" width="50" alt="${p.name}">
        <div class="flex-grow-1">
          <h6 class="mb-0 fw-bold">${p.name}</h6>
          <div class="rating mb-1">
            <i class="fas fa-star text-warning"></i>
            <span class="ms-1">${p.rating}</span>
            <span class="text-muted ms-2">(${p.jobs_count} jobs)</span>
          </div>
          <div class="text-muted small">
            <i class="fas fa-map-marker-alt me-1"></i>
            ${p.distance_km ? p.distance_km.toFixed(1) + ' km away' : 'Distance unknown'}
          </div>
        </div>
        <div class="text-end">
          <div class="fw-bold text-primary mb-1">₹${p.hourly_rate || 500}/hr</div>
          <button class="btn btn-outline-primary btn-sm bookBtn" data-id='${p.id || ''}'>Book</button>
        </div>
      </div>
      <div class="skills">
        <small class="text-muted">Skills:</small>
        <div class="mt-1">
          ${p.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
        </div>
      </div>
    `;
    
    providerList.appendChild(card);
    
    // Add click handler to center map on provider
    card.addEventListener('click', () => {
      map.setView([p.lat, p.lon], 15);
      marker.openPopup();
    });
  });
  
  if (userLat && userLon) {
    L.circleMarker([userLat, userLon], { 
      radius: 8, 
      color: '#0d6efd', 
      fillColor: '#0d6efd', 
      fillOpacity: 0.8 
    }).addTo(map).bindPopup('Your location');
    map.setView([userLat, userLon], 13);
  }
  
  if (nearest) {
    nearest.setIcon(new L.Icon.Default({}));
    nearest.bindTooltip('Nearest', { 
      permanent: true, 
      className: 'badge bg-success text-wrap' 
    }).openTooltip();
  }
  
  // Update provider count
  document.getElementById('providerCount').textContent = providers.length;
  
  // Show/hide loading states
  document.getElementById('loadingProviders').classList.add('d-none');
  if (providers.length === 0) {
    document.getElementById('noProviders').classList.remove('d-none');
  } else {
    document.getElementById('noProviders').classList.add('d-none');
  }
  
  // Enable booking buttons
  setTimeout(() => {
    document.querySelectorAll('.bookBtn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const token = localStorage.getItem('token') || '';
        if (!token) { 
          window.location.href = '/login'; 
          return; 
        }
        
        const providerId = e.target.dataset.id;
        const provider = providers.find(p => p.id === providerId);
        
        if (provider) {
          // Redirect to booking map with provider pre-selected
          window.location.href = `/booking-map?provider_id=${providerId}`;
        }
      });
    });
  }, 0);
}

// Load providers
async function loadProviders(lat, lon) {
  try {
    document.getElementById('loadingProviders').classList.remove('d-none');
    document.getElementById('noProviders').classList.add('d-none');
    
    const response = await fetch(`/providers/nearby?lat=${lat}&lon=${lon}`);
    providers = await response.json();
    renderProviders(providers, lat, lon);
  } catch (error) {
    console.error('Error loading providers:', error);
    document.getElementById('loadingProviders').classList.add('d-none');
    document.getElementById('noProviders').classList.remove('d-none');
  }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  initializeMap();
  
  // Location button
  document.getElementById('locateBtn').addEventListener('click', () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        userLocation = { lat, lon };
        loadProviders(lat, lon);
      });
    }
  });
  
  // Refresh button
  document.getElementById('refreshProviders').addEventListener('click', () => {
    if (userLocation) {
      loadProviders(userLocation.lat, userLocation.lon);
    } else if (initLat && initLon) {
      loadProviders(initLat, initLon);
    }
  });
  
  // Search providers
  document.getElementById('providerSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const providerCards = document.querySelectorAll('.provider-card');
    
    providerCards.forEach(card => {
      const name = card.querySelector('h6').textContent.toLowerCase();
      const skills = card.textContent.toLowerCase();
      
      if (name.includes(searchTerm) || skills.includes(searchTerm)) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  });
  
  // Load initial data
  if (initLat && initLon) {
    userLocation = { lat: initLat, lon: initLon };
    loadProviders(initLat, initLon);
  } else if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      userLocation = { lat, lon };
      loadProviders(lat, lon);
    });
  }
});
</script>

<style>
.provider-card {
  transition: all 0.3s ease;
  cursor: pointer;
}

.provider-card:hover {
  border-color: #0d6efd !important;
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
}

.map-controls .btn {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.provider-panel {
  border-left: 1px solid rgba(0, 0, 0, 0.1);
}

.search-box .input-group-text {
  border-color: #dee2e6;
}

@media (max-width: 992px) {
  .provider-panel {
    border-left: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  #map {
    height: 50vh !important;
  }
  
  .provider-list {
    max-height: 40vh !important;
  }
}
</style>
{% endblock %}









