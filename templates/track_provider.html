{% extends 'base.html' %}
{% block content %}
<div class="container-fluid px-0">
  <!-- Tracking Header -->
  <section class="py-4 bg-gradient-primary text-white">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-8">
          <div class="d-flex align-items-center mb-2">
            <a href="/dashboard/user" class="btn btn-outline-light btn-sm me-3">
              <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
            <h2 class="mb-0 fw-bold">Track Your Provider</h2>
          </div>
          <p class="text-white-50 mb-0">Real-time location tracking and ETA</p>
        </div>
        <div class="col-lg-4 text-lg-end">
          <div class="tracking-status-card p-3 rounded-4 bg-white bg-opacity-10 border border-white border-opacity-25">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0 fw-bold text-white" id="providerName">Provider Name</h6>
              <span class="badge bg-success" id="providerStatus">On the way</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-white-50 small">ETA:</span>
              <span class="fw-bold text-white" id="etaDisplay">15 mins</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tracking Map -->
  <section class="py-4 bg-light">
    <div class="container">
      <div class="row g-4">
        <!-- Map Section -->
        <div class="col-lg-8">
          <div class="card shadow-sm rounded-4 border-0">
            <div class="card-header bg-white border-0 pb-0">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="fw-bold mb-0">Live Tracking</h5>
                <div class="d-flex gap-2">
                  <button id="centerMapBtn" class="btn btn-outline-primary btn-sm rounded-pill">
                    <i class="fas fa-crosshairs me-1"></i>Center Map
                  </button>
                  <button id="refreshLocationBtn" class="btn btn-primary btn-sm rounded-pill">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="trackingMap" style="height: 400px; border-radius: 0.75rem; overflow: hidden;"></div>
            </div>
          </div>
        </div>

        <!-- Tracking Details -->
        <div class="col-lg-4">
          <div class="card shadow-sm rounded-4 border-0 mb-4">
            <div class="card-header bg-white border-0 pb-0">
              <h5 class="fw-bold mb-3">Tracking Details</h5>
            </div>
            <div class="card-body">
              <div class="tracking-info">
                <div class="info-item d-flex align-items-center mb-3">
                  <div class="info-icon me-3">
                    <i class="fas fa-user text-primary"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">Provider</div>
                    <div class="text-muted small" id="providerNameDetail">Loading...</div>
                  </div>
                </div>
                
                <div class="info-item d-flex align-items-center mb-3">
                  <div class="info-icon me-3">
                    <i class="fas fa-route text-info"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">Distance</div>
                    <div class="text-muted small" id="distanceDetail">Calculating...</div>
                  </div>
                </div>
                
                <div class="info-item d-flex align-items-center mb-3">
                  <div class="info-icon me-3">
                    <i class="fas fa-clock text-warning"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">Estimated Arrival</div>
                    <div class="text-muted small" id="etaDetail">Calculating...</div>
                  </div>
                </div>
                
                <div class="info-item d-flex align-items-center mb-3">
                  <div class="info-icon me-3">
                    <i class="fas fa-map-marker-alt text-success"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">Current Location</div>
                    <div class="text-muted small" id="currentLocation">Loading...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Contact Provider -->
          <div class="card shadow-sm rounded-4 border-0">
            <div class="card-header bg-white border-0 pb-0">
              <h5 class="fw-bold mb-3">Contact Provider</h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary rounded-pill" id="callProviderBtn">
                  <i class="fas fa-phone me-2"></i>Call Provider
                </button>
                <button class="btn btn-outline-success rounded-pill" id="messageProviderBtn">
                  <i class="fas fa-message me-2"></i>Send Message
                </button>
                <button class="btn btn-outline-warning rounded-pill" id="cancelBookingBtn">
                  <i class="fas fa-times me-2"></i>Cancel Booking
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Booking Details -->
  <section class="py-4 bg-white">
    <div class="container">
      <div class="card shadow-sm rounded-4 border-0">
        <div class="card-header bg-white border-0 pb-0">
          <h5 class="fw-bold mb-3">Booking Details</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <div class="booking-detail-item">
                <div class="fw-semibold text-muted small">Service</div>
                <div class="fw-bold" id="serviceName">Electrician</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="booking-detail-item">
                <div class="fw-semibold text-muted small">Booking ID</div>
                <div class="fw-bold" id="bookingId">#12345</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="booking-detail-item">
                <div class="fw-semibold text-muted small">Scheduled Time</div>
                <div class="fw-bold" id="scheduledTime">Today, 2:00 PM</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="booking-detail-item">
                <div class="fw-semibold text-muted small">Price</div>
                <div class="fw-bold text-success" id="bookingPrice">₹500</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  'use strict';
  
  // Global variables
  let trackingMap;
  let providerMarker;
  let userMarker;
  let trackingInterval;
  let socket;
  
  // Get URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const providerId = urlParams.get('provider_id');
  const bookingId = urlParams.get('booking_id');
  
  // Initialize tracking
  document.addEventListener('DOMContentLoaded', async function() {
    if (!providerId) {
      showError('Provider ID not provided');
      return;
    }
    
    await initializeTracking();
    setupSocketConnection();
    startTracking();
    setupEventListeners();
  });
  
  // Initialize tracking map
  async function initializeTracking() {
    // Initialize map
    trackingMap = L.map('trackingMap').setView([28.6139, 77.2090], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(trackingMap);
    
    // Get user location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(position => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        
        userMarker = L.marker([userLat, userLon], {
          icon: L.divIcon({
            className: 'user-marker',
            html: '<div class="user-location-marker"><i class="fas fa-home"></i></div>',
            iconSize: [30, 30]
          })
        }).addTo(trackingMap);
        userMarker.bindPopup('Your location');
        
        // Update map view
        trackingMap.fitBounds([
          [userLat, userLon],
          [28.6139, 77.2090] // Provider default location
        ]);
      });
    }
    
    // Load initial provider location
    await loadProviderLocation();
  }
  
  // Load provider location and details
  async function loadProviderLocation() {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`/providers/${providerId}/track`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (response.ok) {
        const trackingData = await response.json();
        updateTrackingDisplay(trackingData);
        updateMapMarkers(trackingData);
      } else {
        showError('Failed to load provider location');
      }
    } catch (error) {
      console.error('Error loading provider location:', error);
      showError('Failed to load provider location');
    }
  }
  
  // Update tracking display
  function updateTrackingDisplay(data) {
    document.getElementById('providerName').textContent = data.provider_name;
    document.getElementById('providerNameDetail').textContent = data.provider_name;
    document.getElementById('distanceDetail').textContent = `${data.distance_km} km`;
    document.getElementById('etaDetail').textContent = `${data.eta_minutes} minutes`;
    document.getElementById('etaDisplay').textContent = `${data.eta_minutes} mins`;
    document.getElementById('currentLocation').textContent = data.location.address || 'Location available';
    document.getElementById('providerStatus').textContent = data.status;
  }
  
  // Update map markers
  function updateMapMarkers(data) {
    // Remove existing provider marker
    if (providerMarker) {
      trackingMap.removeLayer(providerMarker);
    }
    
    // Add provider marker
    providerMarker = L.marker([data.location.lat, data.location.lon], {
      icon: L.divIcon({
        className: 'provider-marker',
        html: '<div class="provider-location-marker"><i class="fas fa-tools"></i></div>',
        iconSize: [30, 30]
      })
    }).addTo(trackingMap);
    
    providerMarker.bindPopup(`
      <div class="provider-popup">
        <h6 class="mb-1 fw-bold">${data.provider_name}</h6>
        <div class="text-muted small">Distance: ${data.distance_km} km</div>
        <div class="text-muted small">ETA: ${data.eta_minutes} minutes</div>
      </div>
    `);
    
    // Fit map to show both markers
    if (userMarker && providerMarker) {
      const group = new L.featureGroup([userMarker, providerMarker]);
      trackingMap.fitBounds(group.getBounds().pad(0.1));
    }
  }
  
  // Setup Socket.IO connection
  function setupSocketConnection() {
    socket = io();
    
    // Listen for provider location updates
    socket.on('provider_location_update', (data) => {
      if (data.provider_id === providerId) {
        updateMapMarkers({
          provider_name: data.name,
          location: {
            lat: data.lat,
            lon: data.lon,
            address: 'Current location'
          },
          distance_km: 'Calculating...',
          eta_minutes: 'Calculating...',
          status: 'On the way'
        });
        
        // Reload tracking data for updated ETA
        loadProviderLocation();
      }
    });
  }
  
  // Start tracking
  function startTracking() {
    // Update location every 30 seconds
    trackingInterval = setInterval(loadProviderLocation, 30000);
  }
  
  // Setup event listeners
  function setupEventListeners() {
    // Center map button
    document.getElementById('centerMapBtn').addEventListener('click', () => {
      if (userMarker && providerMarker) {
        const group = new L.featureGroup([userMarker, providerMarker]);
        trackingMap.fitBounds(group.getBounds().pad(0.1));
      }
    });
    
    // Refresh location button
    document.getElementById('refreshLocationBtn').addEventListener('click', () => {
      loadProviderLocation();
    });
    
    // Contact buttons
    document.getElementById('callProviderBtn').addEventListener('click', () => {
      // Implement calling functionality
      alert('Calling provider...');
    });
    
    document.getElementById('messageProviderBtn').addEventListener('click', () => {
      // Implement messaging functionality
      alert('Opening chat...');
    });
    
    document.getElementById('cancelBookingBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to cancel this booking?')) {
        // Implement cancellation
        alert('Booking cancelled');
      }
    });
  }
  
  // Show error message
  function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      <div class="d-flex align-items-center">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span>${message}</span>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
      </div>
    `;
    document.body.appendChild(alertDiv);
  }
  
  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (trackingInterval) {
      clearInterval(trackingInterval);
    }
    if (socket) {
      socket.disconnect();
    }
  });
  
})();
</script>

<style>
.user-location-marker {
  width: 30px;
  height: 30px;
  background: #0d6efd;
  border: 3px solid white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.provider-location-marker {
  width: 30px;
  height: 30px;
  background: #198754;
  border: 3px solid white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

.tracking-status-card {
  backdrop-filter: blur(10px);
}

.info-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.booking-detail-item {
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 0.5rem;
  text-align: center;
}

.provider-popup {
  min-width: 150px;
}
</style>
{% endblock %}

