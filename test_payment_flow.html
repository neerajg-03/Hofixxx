<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Payment Flow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .debug-info { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .booking-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .status-badge { font-size: 0.8em; }
        .btn-group .btn { margin: 2px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Payment Flow Test</h1>
        
        <div class="debug-info">
            <h5>Debug Information</h5>
            <div id="debugInfo"></div>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <h3>Your Bookings</h3>
                <div id="bookingsList"></div>
            </div>
            <div class="col-md-4">
                <h3>Instructions</h3>
                <div class="alert alert-info">
                    <h6>To see payment option:</h6>
                    <ol>
                        <li>Login as user: <code>testuser@example.com</code></li>
                        <li>Look for bookings with status "Completed"</li>
                        <li>Payment button appears as ðŸ’³ icon</li>
                        <li>If you don't see it, check the debug info above</li>
                    </ol>
                </div>
                
                <div class="alert alert-warning">
                    <h6>Payment Button Conditions:</h6>
                    <ul>
                        <li>Status = "Completed"</li>
                        <li>has_payment = false</li>
                        <li>rating = NOT null (must be rated first!)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load and display bookings
        async function loadBookings() {
            const token = localStorage.getItem('token');
            if (!token) {
                document.getElementById('debugInfo').innerHTML = '<div class="alert alert-danger">No token found. Please login first.</div>';
                return;
            }

            try {
                const response = await fetch('/bookings/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const bookings = await response.json();
                    displayBookings(bookings);
                    displayDebugInfo(bookings);
                } else {
                    const error = await response.text();
                    document.getElementById('debugInfo').innerHTML = `<div class="alert alert-danger">Error: ${response.status} - ${error}</div>`;
                }
            } catch (error) {
                document.getElementById('debugInfo').innerHTML = `<div class="alert alert-danger">Exception: ${error.message}</div>`;
            }
        }

        function displayBookings(bookings) {
            const container = document.getElementById('bookingsList');
            
            if (!bookings || bookings.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No bookings found</div>';
                return;
            }

            container.innerHTML = bookings.map(booking => `
                <div class="booking-card">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>${booking.service_name || 'Service'}</h6>
                            <p class="text-muted mb-1">Price: â‚¹${booking.price || 0}</p>
                            <p class="text-muted mb-1">Created: ${new Date(booking.created_at).toLocaleDateString()}</p>
                            <p class="text-muted mb-1">Status: <span class="badge bg-${getStatusColor(booking.status)} status-badge">${booking.status}</span></p>
                        </div>
                        <div class="col-md-4">
                            <div class="btn-group-vertical w-100">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewBooking('${booking.id}')">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                                
                                ${booking.status === 'In Progress' || booking.status === 'Accepted' ? `
                                    <button class="btn btn-outline-success btn-sm" onclick="trackProvider('${booking.id}')">
                                        <i class="fas fa-map-marker-alt"></i> Track Provider
                                    </button>
                                ` : ''}
                                
                                ${booking.status === 'Completed' && !booking.rating ? `
                                    <button class="btn btn-outline-warning btn-sm" onclick="rateBooking('${booking.id}')">
                                        <i class="fas fa-star"></i> Rate Service
                                    </button>
                                ` : ''}
                                
                                ${booking.status === 'Completed' && booking.rating ? `
                                    <span class="badge bg-success">Rated ${booking.rating}/5</span>
                                ` : ''}
                                
                                ${booking.status === 'Completed' && booking.rating && !booking.has_payment ? `
                                    <button class="btn btn-outline-primary btn-sm" onclick="makePayment('${booking.id}')" style="background-color: #007bff; color: white;">
                                        <i class="fas fa-credit-card"></i> ðŸ’³ Make Payment
                                    </button>
                                ` : ''}
                                
                                ${booking.status === 'Completed' && booking.has_payment ? `
                                    <span class="badge bg-${booking.payment_status === 'Success' ? 'success' : 'warning'}">${booking.payment_status}</span>
                                ` : ''}
                                
                                ${booking.status === 'Completed' ? `
                                    <button class="btn btn-outline-info btn-sm" onclick="viewCompletion('${booking.id}')">
                                        <i class="fas fa-check-circle"></i> View Completion
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayDebugInfo(bookings) {
            const debugInfo = document.getElementById('debugInfo');
            const completedBookings = bookings.filter(b => b.status === 'Completed');
            
            debugInfo.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Booking Summary:</h6>
                        <ul>
                            <li>Total bookings: ${bookings.length}</li>
                            <li>Completed bookings: ${completedBookings.length}</li>
                            <li>With payment: ${completedBookings.filter(b => b.has_payment).length}</li>
                            <li>Without payment: ${completedBookings.filter(b => !b.has_payment).length}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Completed Bookings Details:</h6>
                        ${completedBookings.map(b => `
                            <div class="small">
                                <strong>${b.service_name}</strong><br>
                                Status: ${b.status}<br>
                                Has Payment: ${b.has_payment}<br>
                                Payment Status: ${b.payment_status || 'N/A'}<br>
                                Rating: ${b.rating || 'Not rated'}<br>
                                <hr>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Pending': return 'warning';
                case 'Accepted': return 'primary';
                case 'In Progress': return 'info';
                case 'Completed': return 'success';
                case 'Cancelled': return 'danger';
                case 'Rejected': return 'danger';
                default: return 'secondary';
            }
        }

        // Mock functions for buttons
        function viewBooking(id) {
            alert(`View booking: ${id}`);
        }

        function trackProvider(id) {
            alert(`Track provider for booking: ${id}`);
        }

        function rateBooking(id) {
            alert(`Rate booking: ${id}`);
        }

        function makePayment(id) {
            alert(`Make payment for booking: ${id}`);
        }

        function viewCompletion(id) {
            alert(`View completion for booking: ${id}`);
        }

        // Load bookings on page load
        window.addEventListener('load', loadBookings);
    </script>
</body>
</html>
